<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Chimera: The Polished Experience v6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .backface-hidden { backface-visibility: hidden; -webkit-backface-visibility: hidden; }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slide-up { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-fade-in { animation: fade-in 0.3s ease-out; }
        .animate-slide-up { animation: slide-up 0.4s ease-out; }
        .mood-button[data-selected="true"] { transform: scale(1.2); border-color: #3b82f6; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1.5s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .skeleton { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .game-area { touch-action: none; }
        .chat-bubble-ai { background-color: #e5e7eb; }
        .chat-bubble-user { background-color: #3b82f6; color: white; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        // --- constants.js ---
        const THEMES = { dog: { park: { name: 'Park', colors: { from: 'from-lime-400', to: 'to-emerald-600' }}, beach: { name: 'Beach', colors: { from: 'from-sky-400', to: 'to-blue-600' }}, city: { name: 'City', colors: { from: 'from-gray-500', to: 'to-slate-700' }}}, cat: { farm: { name: 'Farm', colors: { from: 'from-red-400', to: 'to-yellow-500' }}, castle: { name: 'Castle', colors: { from: 'from-indigo-400', to: 'to-purple-600' }}, palace: { name: 'Palace', colors: { from: 'from-fuchsia-500', to: 'to-pink-700' }}}};
        const ANIMAL_CONTENT = { dog: { type: 'dog', apiEndpoint: 'https://dog.ceo/api/breeds/image/random', parseApiResponse: (data) => ({ image: data.message, breed: data.message.split('/breeds/')[1].split('/')[0].replace('-', ' ') }), aiTitle: "Canine Counselor", game: { title: "Catch the Treats!", treats: ['ü¶¥', 'üçñ'], catcher: 'üê∂' }}, cat: { type: 'cat', apiEndpoint: 'https://api.thecatapi.com/v1/images/search?has_breeds=1', parseApiResponse: (data) => ({ image: data[0].url, breed: data[0].breeds.length > 0 ? data[0].breeds[0].name : 'Mysterious Cat' }), aiTitle: "Meow Musings", game: { title: "Catch the Fishies!", treats: ['üêü', 'üê†'], catcher: 'üê±' }}};
    </script>
    
    <script type="module">
        // --- firebase.js ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, getDocs, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebase = {
          initializeApp,
          getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken,
          getFirestore, doc, getDoc, setDoc, deleteDoc, collection, getDocs, onSnapshot, serverTimestamp
        };
        document.dispatchEvent(new CustomEvent('firebaseReady'));
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, createContext, useContext, useReducer } = React;
        const { createRoot } = ReactDOM;
        
        // --- Contexts ---
        const FirebaseContext = createContext(null);
        const AppContext = createContext();

        // --- providers/FirebaseProvider.js ---
        const FirebaseProvider = ({ children }) => {
            const [services, setServices] = useState({ auth: null, db: null, userId: null, isAuthReady: false });
            useEffect(() => {
                const initFirebase = async () => {
                    if (window.firebase) {
                        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                        const app = window.firebase.initializeApp(firebaseConfig);
                        const auth = window.firebase.getAuth(app);
                        const db = window.firebase.getFirestore(app);
                        window.firebase.onAuthStateChanged(auth, async (user) => {
                            if (user) {
                                setServices({ auth, db, userId: user.uid, isAuthReady: true });
                            } else {
                                try {
                                    const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                                    if (token) await window.firebase.signInWithCustomToken(auth, token);
                                    else await window.firebase.signInAnonymously(auth);
                                } catch (error) { console.error("Sign-in failed", error); }
                            }
                        });
                    }
                };
                document.addEventListener('firebaseReady', initFirebase, { once: true });
            }, []);
            return <FirebaseContext.Provider value={services}>{services.isAuthReady ? children : <div className="w-screen h-screen flex items-center justify-center"><div className="loader"></div></div>}</FirebaseContext.Provider>;
        };

        // --- App.js ---
        const initialState = { currentDate: new Date(), calendarSide: 'dog', activeModal: null, dogThemeKey: 'park', catThemeKey: 'farm', animalDataCache: {}, journalEntries: {}, favorites: [], isLoadingAnimal: true, isNewUser: null };
        function appReducer(state, action) {
            switch (action.type) {
                case 'SET_DATE': return { ...state, currentDate: action.payload };
                case 'FLIP_SIDE': return { ...state, calendarSide: state.calendarSide === 'dog' ? 'cat' : 'dog' };
                case 'SET_THEME': return state.calendarSide === 'dog' ? { ...state, dogThemeKey: action.payload } : { ...state, catThemeKey: action.payload };
                case 'SET_MODAL': return { ...state, activeModal: action.payload };
                case 'START_LOADING_ANIMAL': return { ...state, isLoadingAnimal: true };
                case 'SET_ANIMAL_DATA': return { ...state, isLoadingAnimal: false, animalDataCache: { ...state.animalDataCache, [action.payload.key]: action.payload.data } };
                case 'SET_JOURNAL_ENTRIES': return { ...state, journalEntries: action.payload };
                case 'SET_FAVORITES': return { ...state, favorites: action.payload };
                case 'SET_IS_NEW_USER': return { ...state, isNewUser: action.payload };
                default: return state;
            }
        }
        
        const App = () => {
          const [state, dispatch] = useReducer(appReducer, initialState);
          const { db, userId } = useContext(FirebaseContext);
          const { currentDate, calendarSide, dogThemeKey, catThemeKey, animalDataCache } = state;
          const dateKey = currentDate.toISOString().split('T')[0];
          const animalType = calendarSide;
          const cacheKey = `${dateKey}-${animalType}`;
          const activeThemeKey = animalType === 'dog' ? dogThemeKey : catThemeKey;
          const activeTheme = THEMES[animalType][activeThemeKey];
          const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

          // Custom Hooks
          const useAnimalData = (key, type) => {
              useEffect(() => {
                  if (!animalDataCache[key]) {
                      dispatch({ type: 'START_LOADING_ANIMAL' });
                      fetch(ANIMAL_CONTENT[type].apiEndpoint)
                          .then(res => res.json())
                          .then(data => dispatch({ type: 'SET_ANIMAL_DATA', payload: { key, data: ANIMAL_CONTENT[type].parseApiResponse(data) } }))
                          .catch(err => console.error(err));
                  }
              }, [key, type]);
          };

          const useFirestoreCollection = (collectionName, actionType) => {
            useEffect(() => {
                if (!db || !userId) return;
                const collectionRef = window.firebase.collection(db, "artifacts", appId, "users", userId, collectionName);
                const unsubscribe = window.firebase.onSnapshot(collectionRef, (snapshot) => {
                    const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (collectionName === 'journal' && state.isNewUser === null) {
                        dispatch({ type: 'SET_IS_NEW_USER', payload: items.length === 0 });
                    }
                    if (collectionName === 'journal') {
                        const entriesMap = items.reduce((acc, item) => { acc[item.id] = item; return acc; }, {});
                        dispatch({ type: actionType, payload: entriesMap });
                    } else {
                        dispatch({ type: actionType, payload: items });
                    }
                });
                return () => unsubscribe();
            }, [db, userId, appId]);
          };
          
          useAnimalData(cacheKey, animalType);
          useFirestoreCollection('journal', 'SET_JOURNAL_ENTRIES');
          useFirestoreCollection('favorites', 'SET_FAVORITES');
          
          useEffect(() => {
            if (state.isNewUser === true) {
                dispatch({ type: 'SET_MODAL', payload: 'onboarding' });
            }
          }, [state.isNewUser]);

          return (
            <AppContext.Provider value={{ state, dispatch }}>
              <div className="min-h-screen font-sans p-4 flex flex-col items-center">
                <AnimatedBackground theme={activeTheme} />
                <AppHeader />
                <div className="perspective-1000 w-full max-w-2xl">
                    <div className={`w-full transition-transform duration-700 transform-style-3d ${calendarSide === 'cat' ? 'rotate-y-180' : ''}`}>
                        {['dog', 'cat'].map(side => (
                            <div key={side} className={`w-full bg-white/70 backdrop-blur-lg rounded-2xl shadow-2xl overflow-hidden backface-hidden ${side === 'cat' ? 'absolute top-0 left-0 rotate-y-180' : ''}`}>
                                <CalendarPage animalType={side} />
                            </div>
                        ))}
                    </div>
                </div>
                <AppModals />
              </div>
            </AppContext.Provider>
          );
        };
        
        // --- Components ---
        const AppHeader = () => {
            const { state, dispatch } = useContext(AppContext);
            return (
              <header className="w-full max-w-2xl mx-auto flex justify-between items-center mb-4 z-10">
                <button onClick={() => dispatch({ type: 'SET_MODAL', payload: 'settings' })} className="bg-white/80 backdrop-blur-sm p-2 rounded-lg shadow-md text-xl font-bold transition-transform hover:scale-105" aria-label="Open Settings">‚öôÔ∏è</button>
                <div>
                  <button onClick={() => dispatch({ type: 'SET_MODAL', payload: 'favorites' })} className="bg-white/80 backdrop-blur-sm p-2 rounded-lg shadow-md text-xl font-bold transition-transform hover:scale-105 mr-2" aria-label="View Favorites">‚ù§Ô∏è</button>
                  <button onClick={() => dispatch({ type: 'SET_MODAL', payload: 'memories' })} className="bg-white/80 backdrop-blur-sm p-2 rounded-lg shadow-md text-xl font-bold transition-transform hover:scale-105 mr-2" aria-label="View Memories">üìö</button>
                  <button onClick={() => dispatch({ type: 'FLIP_SIDE' })} className="bg-white/80 backdrop-blur-sm p-2 rounded-lg shadow-md text-lg font-bold transition-transform hover:scale-105">Flip to {state.calendarSide === 'dog' ? 'üê±' : 'üê∂'}</button>
                </div>
              </header>
            );
        };
        
        const CalendarPage = ({ animalType }) => {
            const { state, dispatch } = useContext(AppContext);
            const { db, userId } = useContext(FirebaseContext);
            const { currentDate, animalDataCache, favorites, isLoadingAnimal, dogThemeKey, catThemeKey, journalEntries } = state;
            const dateKey = currentDate.toISOString().split('T')[0];
            const cacheKey = `${dateKey}-${animalType}`;
            const animalData = animalDataCache[cacheKey];
            const themeKey = animalType === 'dog' ? dogThemeKey : catThemeKey;
            const theme = THEMES[animalType][themeKey];
            const { day, weekday, month, year } = { day: currentDate.getDate(), weekday: currentDate.toLocaleDateString('en-US', { weekday: 'long' }), month: currentDate.toLocaleDateString('en-US', { month: 'long' }), year: currentDate.getFullYear() };
            const isFavorited = favorites.some(fav => fav.id === cacheKey);
            const hasJournalEntry = !!journalEntries[dateKey];
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            const handleToggleFavorite = async () => {
                if (!animalData || !db || !userId) return;
                const favDocRef = window.firebase.doc(db, "artifacts", appId, "users", userId, "favorites", cacheKey);
                try {
                    if (isFavorited) await window.firebase.deleteDoc(favDocRef);
                    else await window.firebase.setDoc(favDocRef, { ...animalData, date: dateKey, animalType });
                } catch (error) { console.error("Favorite toggle failed:", error); }
            };

            const handleDateChange = (days) => {
                const newDate = new Date(currentDate);
                newDate.setDate(newDate.getDate() + days);
                dispatch({ type: 'SET_DATE', payload: newDate });
            };

            return (
                <div className="flex flex-col">
                    <div className="relative h-80 sm:h-96">
                        {isLoadingAnimal || !animalData ? <div className="w-full h-full bg-gray-200 skeleton"></div> : (
                            <>
                                <img src={animalData.image} alt={animalData.breed} className="w-full h-full object-cover" />
                                <button onClick={handleToggleFavorite} className={`absolute top-4 left-4 p-2 text-2xl bg-white/50 backdrop-blur-sm rounded-full shadow-lg hover:scale-110 transition-all ${isFavorited ? 'text-red-500' : 'text-white'}`}>‚ô•</button>
                            </>
                        )}
                        <div className="absolute inset-x-0 bottom-0 p-4 text-white">
                            <div className="flex justify-between items-end">
                                <div><div className="text-6xl font-bold leading-none">{day}</div><div className="font-medium">{weekday}</div></div>
                                <div className="text-right"><div className="text-2xl font-bold">{month}</div><div>{year}</div></div>
                            </div>
                        </div>
                        <div className="absolute top-4 right-4 flex gap-2">
                            <button onClick={() => handleDateChange(-1)} className="p-2 bg-white/50 backdrop-blur-sm rounded-full shadow hover:bg-white/80 transition" aria-label="Previous Day">{'<'}</button>
                            <button onClick={() => handleDateChange(1)} className="p-2 bg-white/50 backdrop-blur-sm rounded-full shadow hover:bg-white/80 transition" aria-label="Next Day">{'>'}</button>
                        </div>
                    </div>
                    <div className="grid grid-cols-3 gap-2 p-3">
                        <InteractiveCard icon="‚úçÔ∏è" title="Journal" onClick={() => dispatch({ type: 'SET_MODAL', payload: 'journal' })} hasBadge={hasJournalEntry} />
                        <InteractiveCard icon="‚ú®" title="AI Chat" onClick={() => dispatch({ type: 'SET_MODAL', payload: 'ai' })} />
                        <InteractiveCard icon="üéÆ" title="Game" onClick={() => dispatch({ type: 'SET_MODAL', payload: 'game' })} />
                        <InteractiveCard icon="üí°" title="Breed Info" onClick={() => dispatch({ type: 'SET_MODAL', payload: 'breed' })} />
                        <InteractiveCard icon="üìä" title="Analytics" onClick={() => dispatch({ type: 'SET_MODAL', payload: 'analytics' })} />
                        <InteractiveCard icon="üóìÔ∏è" title="On This Day" onClick={() => dispatch({ type: 'SET_MODAL', payload: 'onThisDay' })} />
                    </div>
                </div>
            );
        };
        
        const InteractiveCard = ({ icon, title, onClick, hasBadge = false }) => (
            <button onClick={onClick} className="relative p-2 bg-white/50 rounded-lg shadow-lg text-center transition-transform hover:scale-105 active:scale-95 flex flex-col items-center justify-center aspect-square">
                {hasBadge && <div className="absolute top-1 right-1 w-3 h-3 bg-blue-500 rounded-full border-2 border-white"></div>}
                <div className="text-3xl">{icon}</div><div className="text-xs font-semibold mt-1">{title}</div>
            </button>
        );

        const FocusTrapModal = ({ children, onClose, title }) => {
            const modalRef = useRef(null);
            useEffect(() => {
                const focusableElements = modalRef.current?.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                if (!focusableElements || focusableElements.length === 0) return;
                const firstElement = focusableElements[0];
                const lastElement = focusableElements[focusableElements.length - 1];
                const handleTabKey = (e) => {
                    if (e.key !== 'Tab') return;
                    if (e.shiftKey) { if (document.activeElement === firstElement) { lastElement.focus(); e.preventDefault(); } }
                    else { if (document.activeElement === lastElement) { firstElement.focus(); e.preventDefault(); } }
                };
                const handleEscapeKey = (e) => { if (e.key === 'Escape') onClose(); }
                firstElement?.focus();
                document.addEventListener('keydown', handleTabKey);
                document.addEventListener('keydown', handleEscapeKey);
                return () => {
                    document.removeEventListener('keydown', handleTabKey);
                    document.removeEventListener('keydown', handleEscapeKey);
                };
            }, [onClose]);
            return (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-md z-50 flex items-center justify-center p-4 animate-fade-in" onClick={onClose} role="dialog" aria-modal="true" aria-label={title}>
                    <div ref={modalRef} className="bg-white/90 rounded-xl shadow-2xl max-w-lg w-full relative animate-slide-up" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-2 right-2 p-1 text-2xl text-gray-500 hover:text-gray-800" aria-label="Close modal">&times;</button>
                        {children}
                    </div>
                </div>
            );
        };
        
        // --- Modals ---
        const AppModals = () => {
          const { state, dispatch } = useContext(AppContext);
          const { activeModal, calendarSide, currentDate, animalDataCache, journalEntries } = state;
          if (!activeModal) return null;
          const dateKey = currentDate.toISOString().split('T')[0];
          const cacheKey = `${dateKey}-${calendarSide}`;
          const animalData = animalDataCache[cacheKey] || { breed: 'Loading...'};
          const content = ANIMAL_CONTENT[calendarSide];
          return (
            <FocusTrapModal onClose={() => dispatch({ type: 'SET_MODAL', payload: null })} title={activeModal}>
              {activeModal === 'onboarding' && <OnboardingModal />}
              {activeModal === 'breed' && <BreedSpotlightModal breed={animalData.breed} />}
              {activeModal === 'settings' && <SettingsModal />}
              {activeModal === 'journal' && <JournalModal date={currentDate} />}
              {activeModal === 'memories' && <MemoriesModal />}
              {activeModal === 'favorites' && <FavoritesModal />}
              {activeModal === 'ai' && <AiModal aiTitle={content.aiTitle} breed={animalData.breed} animalType={content.type} />}
              {activeModal === 'game' && <GameModal gameContent={content.game} />}
              {activeModal === 'onThisDay' && <OnThisDayModal date={currentDate} />}
              {activeModal === 'analytics' && <AnalyticsModal entries={Object.values(journalEntries)} />}
            </FocusTrapModal>
          )
        };
        
        const OnboardingModal = () => {
            return (
                <div className="p-6 text-center">
                    <h2 className="text-2xl font-bold mb-2">Welcome! üêæ</h2>
                    <p className="text-gray-700 mb-4">This is your personal pet calendar and journal. Each day, you'll see a new furry face!</p>
                    <p className="text-gray-700">Use the cards below the image to write in your journal, play a game, chat with our AI, and much more. Your journal entries and favorite photos will be saved to the cloud.</p>
                </div>
            );
        };

        const BreedSpotlightModal = ({ breed }) => {
            return (
                <div className="p-6 border-t-8 border-yellow-400">
                    <h3 className="font-bold text-xl mb-2">Breed Spotlight</h3>
                    <p>Today's featured breed is the <span className="font-bold">{breed}</span>! Every breed is unique, with its own history and temperament.</p>
                </div>
            );
        };
        
        const SettingsModal = () => {
            const { state, dispatch } = useContext(AppContext);
            const { calendarSide, dogThemeKey, catThemeKey } = state;
            const currentThemes = THEMES[calendarSide];
            const activeThemeKey = calendarSide === 'dog' ? dogThemeKey : catThemeKey;

            return (
                <div className="p-6 border-t-8 border-gray-400">
                    <h3 className="font-bold text-xl mb-4">Settings</h3>
                    <div>
                        <label htmlFor="theme-select" className="block text-sm font-medium text-gray-700">Current Theme</label>
                        <select id="theme-select" value={activeThemeKey} onChange={(e) => dispatch({ type: 'SET_THEME', payload: e.target.value })} className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            {Object.entries(currentThemes).map(([key, theme]) => <option key={key} value={key}>{theme.name}</option>)}
                        </select>
                    </div>
                </div>
            );
        };
        
        const JournalModal = ({ date }) => {
            const { db, userId } = useContext(FirebaseContext);
            const { state } = useContext(AppContext);
            const dateKey = date.toISOString().split('T')[0];
            const [entryText, setEntryText] = useState("");
            const [mood, setMood] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [isSaving, setIsSaving] = useState(false);
            const MOODS = ['üòä', 'ü•∞', 'üò¥', 'ü§™', 'ü§¢'];
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            useEffect(() => {
                const journalEntry = state.journalEntries[dateKey];
                setEntryText(journalEntry?.entryText || "");
                setMood(journalEntry?.mood || null);
                setIsLoading(false);
            }, [dateKey, state.journalEntries]);

            const handleSave = async () => {
                if (!db || !userId) return;
                setIsSaving(true);
                const docRef = window.firebase.doc(db, "artifacts", appId, "users", userId, "journal", dateKey);
                try {
                    await window.firebase.setDoc(docRef, { entryText, mood, date: dateKey, timestamp: window.firebase.serverTimestamp() }, { merge: true });
                } catch (error) {
                    console.error("Error saving journal entry:", error);
                } finally {
                    setIsSaving(false);
                }
            };

            if(isLoading) return <div className="p-6 flex justify-center"><div className="loader"></div></div>;

            return (
                <div className="p-6 border-t-8 border-blue-400">
                    <h3 className="font-bold text-xl mb-2">Journal for {date.toLocaleDateString()}</h3>
                    <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-1">How was your pet's day?</label>
                        <div className="flex justify-around bg-gray-100 p-2 rounded-lg">
                            {MOODS.map(m => (
                                <button key={m} onClick={() => setMood(m)} className="text-3xl p-1 rounded-full transition-transform duration-200 mood-button" data-selected={mood === m}>{m}</button>
                            ))}
                        </div>
                    </div>
                    <textarea value={entryText} onChange={(e) => setEntryText(e.target.value)} placeholder="Write about today's adventures..." className="w-full h-40 p-2 border rounded-md" disabled={isSaving} />
                    <button onClick={handleSave} disabled={isSaving} className="w-full mt-4 p-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 disabled:bg-blue-300">{isSaving ? 'Saving...' : 'Save Entry'}</button>
                </div>
            );
        };
        
        const MemoriesModal = () => {
            const { state } = useContext(AppContext);
            const memories = Object.values(state.journalEntries).sort((a,b) => new Date(b.date) - new Date(a.date));

            if (memories.length === 0) {
                return <div className="p-6 text-center"><h3 className="font-bold text-xl mb-2">My Memories</h3><p className="text-gray-600">No journal entries found. Click the "Journal" card to write your first one!</p></div>;
            }

            return (
                <div className="p-6 border-t-8 border-purple-400">
                    <h3 className="font-bold text-xl mb-4 text-center">My Memories</h3>
                    <div className="max-h-[60vh] overflow-y-auto space-y-3">
                        {memories.map(mem => (
                            <div key={mem.id} className="bg-white p-3 rounded-lg shadow">
                                <div className="flex justify-between items-center mb-1">
                                    <p className="font-bold text-gray-800">{new Date(mem.date).toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                    <p className="text-2xl">{mem.mood}</p>
                                </div>
                                <p className="text-gray-600 text-sm italic">"{mem.entryText.substring(0, 100)}{mem.entryText.length > 100 ? '...' : ''}"</p>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };
        
        const FavoritesModal = () => {
            const { state } = useContext(AppContext);
            const { favorites } = state;

            if (favorites.length === 0) {
                return <div className="p-6 text-center"><h3 className="font-bold text-xl mb-2">Favorite Images</h3><p className="text-gray-600">You haven't favorited any pictures yet. Click the heart icon on an image to save it here!</p></div>;
            }

            return (
                <div className="p-6 border-t-8 border-red-400">
                    <h3 className="font-bold text-xl mb-4 text-center">Favorite Images</h3>
                    <div className="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-[60vh] overflow-y-auto">
                        {favorites.map(fav => (
                            <div key={fav.id} className="relative group">
                                <img src={fav.image} alt={fav.breed} className="rounded-lg object-cover aspect-square"/>
                                <div className="absolute inset-0 bg-black/50 flex flex-col items-center justify-center text-center p-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <p className="text-white text-xs font-bold">{fav.breed}</p>
                                    <p className="text-white text-xs">{new Date(fav.date).toLocaleDateString()}</p>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };
        
        const AnalyticsModal = ({ entries }) => {
            const moodData = entries.reduce((acc, entry) => {
                if (entry.mood) acc[entry.mood] = (acc[entry.mood] || 0) + 1;
                return acc;
            }, {});
            const totalMoods = Object.values(moodData).reduce((sum, count) => sum + count, 0);
            const sortedMoods = Object.entries(moodData).sort((a, b) => b[1] - a[1]);

            return (
                <div className="p-6 border-t-8 border-teal-400">
                    <h3 className="font-bold text-xl mb-4 text-center">Mood Analytics</h3>
                    {totalMoods === 0 ? <p className="text-center text-gray-600">No mood data recorded yet. Start adding moods in your journal!</p> : (
                        <div className="space-y-3">
                            {sortedMoods.map(([mood, count]) => (
                                <div key={mood}>
                                    <div className="flex justify-between items-center mb-1 text-sm">
                                        <span className="text-2xl">{mood}</span>
                                        <span className="font-medium">{count} {count > 1 ? 'days' : 'day'}</span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-4">
                                        <div className="bg-teal-500 h-4 rounded-full" style={{ width: `${(count / totalMoods) * 100}%` }}></div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };
        
        const OnThisDayModal = ({ date }) => {
            const facts = { "0-25": "On January 25, 1924, the first Winter Olympics opened. Sled dogs were a popular part of the event!", "4-11": "April 11th is National Pet Day!", "9-28": "September 28th is World Rabies Day, commemorating Louis Pasteur, who developed the first rabies vaccine." };
            const key = `${date.getMonth()}-${date.getDate()}`;
            const fact = facts[key] || "Every day is a good day to be kind to an animal!";
            return (
                <div className="p-6 border-t-8 border-cyan-400">
                    <h3 className="font-bold text-xl mb-2">On This Day...</h3>
                    <p className="text-gray-700">{fact}</p>
                </div>
            );
        };
        
        const GameModal = ({ gameContent }) => {
            const [score, setScore] = useState(0);
            const [treats, setTreats] = useState([]);
            const [catcherX, setCatcherX] = useState(50);
            const gameAreaRef = useRef(null);

            const handlePointerMove = (e) => {
                if (!gameAreaRef.current) return;
                const rect = gameAreaRef.current.getBoundingClientRect();
                const x = e.clientX - rect.left;
                setCatcherX((x / rect.width) * 100);
            };

            useEffect(() => {
                const interval = setInterval(() => {
                    if (Math.random() < 0.1) {
                        setTreats(prev => [...prev, { id: Date.now(), x: Math.random() * 90 + 5, y: 0, emoji: gameContent.treats[Math.floor(Math.random() * gameContent.treats.length)] }]);
                    }
                    setTreats(prev => prev.map(t => ({...t, y: t.y + 2 })).filter(t => {
                        if (t.y > 80 && t.y < 90 && Math.abs(t.x - catcherX) < 8) {
                            setScore(s => s + 10);
                            return false;
                        }
                        return t.y < 100;
                    }));
                }, 50);
                return () => clearInterval(interval);
            }, [catcherX, gameContent.treats]);

            return (
                <div className="p-6 border-t-8 border-green-400 text-center">
                    <h3 className="font-bold text-xl mb-2">{gameContent.title}</h3>
                    <p>Score: <span className="font-bold">{score}</span></p>
                    <div ref={gameAreaRef} onPointerMove={handlePointerMove} className="relative w-full h-64 bg-green-100 rounded-lg mt-4 overflow-hidden game-area select-none">
                        {treats.map(treat => <div key={treat.id} className="absolute text-2xl" style={{ left: `${treat.x}%`, top: `${treat.y}%`, transform: 'translateX(-50%)' }}>{treat.emoji}</div>)}
                        <div className="absolute bottom-0 text-5xl" style={{ left: `${catcherX}%`, transform: 'translateX(-50%)' }}>{gameContent.catcher}</div>
                    </div>
                </div>
            );
        };
        
        const AiModal = ({ aiTitle, breed, animalType }) => {
            const [conversation, setConversation] = useState([]);
            const [userInput, setUserInput] = useState("");
            const [isThinking, setIsThinking] = useState(false);
            const chatEndRef = useRef(null);

            useEffect(() => chatEndRef.current?.scrollIntoView({ behavior: "smooth" }), [conversation]);

            const handleSend = async () => {
                if (!userInput.trim() || isThinking) return;
                const newUserMessage = { role: 'user', text: userInput };
                setConversation(prev => [...prev, newUserMessage]);
                setUserInput("");
                setIsThinking(true);
                try {
                    const prompt = `You are a helpful and friendly pet expert. A user is asking about a ${breed} ${animalType}. Keep your answer concise (2-3 sentences). User's question: "${userInput}"`;
                    let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = { contents: chatHistory };
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const result = await response.json();
                    let aiText = "Sorry, I couldn't think of a response.";
                    if (result.candidates?.[0]?.content.parts[0].text) {
                        aiText = result.candidates[0].content.parts[0].text;
                    }
                    setConversation(prev => [...prev, { role: 'ai', text: aiText }]);
                } catch (error) {
                    console.error("AI API call failed:", error);
                    setConversation(prev => [...prev, { role: 'ai', text: "I'm having trouble connecting right now." }]);
                } finally {
                    setIsThinking(false);
                }
            };

            return (
                <div className="p-6 border-t-8 border-indigo-400 flex flex-col h-[70vh]">
                    <h3 className="font-bold text-xl mb-4 text-center">{aiTitle}</h3>
                    <p className="text-sm text-center text-gray-600 mb-4">Ask me anything about the <span className="font-bold">{breed}</span>!</p>
                    <div className="flex-grow overflow-y-auto bg-gray-100 rounded-lg p-3 space-y-4">
                        {conversation.map((msg, index) => (
                            <div key={index} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`rounded-lg py-2 px-3 max-w-xs lg:max-w-md ${msg.role === 'user' ? 'chat-bubble-user' : 'chat-bubble-ai'}`}>{msg.text}</div>
                            </div>
                        ))}
                        {isThinking && (
                            <div className="flex justify-start">
                                <div className="rounded-lg py-2 px-3 chat-bubble-ai">...</div>
                            </div>
                        )}
                        <div ref={chatEndRef} />
                    </div>
                    <div className="mt-4 flex">
                        <input type="text" value={userInput} onChange={(e) => setUserInput(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && handleSend()} placeholder="Ask a question..." className="w-full p-2 border rounded-l-md focus:outline-none focus:ring-2 focus:ring-indigo-400" disabled={isThinking} />
                        <button onClick={handleSend} className="bg-indigo-500 text-white px-4 rounded-r-md hover:bg-indigo-600 disabled:bg-indigo-300" disabled={isThinking}>Send</button>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<React.StrictMode><FirebaseProvider><App /></FirebaseProvider></React.StrictMode>);
    </script>
</body>
</html>